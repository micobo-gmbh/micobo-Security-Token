<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for constraints/TimeLockConstraintModule.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">constraints/</a> TimeLockConstraintModule.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>0/23</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/14</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/9</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>0/21</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity 0.6.6;
&nbsp;
import "../../node_modules/@openzeppelin/contracts/math/SafeMath.sol";
&nbsp;
import "../interfaces/IConstraintModule.sol";
import "../interfaces/ISecurityToken.sol";
&nbsp;
&nbsp;
/**
 * @author Simon Dosch
 * @title TimeLockConstraintModule
 * @dev ConstraintModule
 * Lock specific accounts or the whole partition for a period of time
 */
contract TimeLockConstraintModule is IConstraintModule {
	using SafeMath for uint256;
&nbsp;
	/**
	 * @dev Address of securityToken this ConstraintModule is used by
	 */
	ISecurityToken private _securityToken;
&nbsp;
	/**
	 * @dev Standard module name
	 */
	bytes32 private _module_name = bytes32("TIME_LOCK");
&nbsp;
	// EVENTS
	/**
	 * @dev Emitted when an amount timelock entry is edited
	 */
	event AmountTimeLockEdit(address account, uint256 time, uint256 amount);
&nbsp;
	/**
	 * @dev Emitted when an account timelock entry is edited
	 */
	event AccountTimeLockEdit(address account, uint256 time);
&nbsp;
	/**
	 * @dev Emitted when the overall timelock entry is edited
	 */
	event TimeLockEdit(uint256 time);
&nbsp;
	// MODULE DATA
	/**
	 * @dev Tracks which amounts are locked for how long
	 */
	mapping(address =&gt; Lock) private _amountTimeLock;
&nbsp;
	struct Lock {
		uint256 time;
		uint256 amount;
	}
&nbsp;
	/**
	 * @dev Tracks which accounts are locked for how long
	 */
	mapping(address =&gt; uint256) private _accountTimeLock;
&nbsp;
	/**
	 * @dev Until when the whole token is locked
	 */
	uint256 private _timeLock;
&nbsp;
	/**
	 * [TimeLockConstraintModule CONSTRUCTOR]
	 * @dev Initialize TimeLockConstraintModule with security token address
	 * @param tokenAddress Address of securityToken this ConstraintModule is used by
	 */
<span class="fstat-no" title="function not covered" >	constructor(address tokenAddress) public {</span>
<span class="cstat-no" title="statement not covered" >		_securityToken = ISecurityToken(tokenAddress)</span>;
	}
&nbsp;
	// MODULE FUNCTIONS
	/**
	 * @dev Edits an account timelock entry
	 * @param account The edited account
	 * @param time The new timestamp until which the amount will be locked
	 * @param amount The amount of tokens being locked
	 */
<span class="fstat-no" title="function not covered" >	function editAmountTimeLock(</span>
		address account,
		uint256 time,
		uint256 amount
	) public {
<span class="cstat-no" title="statement not covered" >		require(</span>
			_securityToken.hasRole(bytes32("TIME_LOCK_EDITOR"), msg.sender),
			"!TIME_LOCK_EDITOR"
		);
<span class="cstat-no" title="statement not covered" >		_amountTimeLock[account] = Lock(time, amount)</span>;
<span class="cstat-no" title="statement not covered" >		emit AmountTimeLockEdit(account, time, amount);</span>
	}
&nbsp;
	/**
	 * @dev Edits an account timelock entry
	 * @param account The edited account
	 * @param time The new timestamp until which this account will be locked
	 */
<span class="fstat-no" title="function not covered" >	function editAccountTimeLock(address account, uint256 time) public {</span>
<span class="cstat-no" title="statement not covered" >		require(</span>
			_securityToken.hasRole(bytes32("TIME_LOCK_EDITOR"), msg.sender),
			"!TIME_LOCK_EDITOR"
		);
<span class="cstat-no" title="statement not covered" >		_accountTimeLock[account] = time</span>;
<span class="cstat-no" title="statement not covered" >		emit AccountTimeLockEdit(account, time);</span>
	}
&nbsp;
	/**
	 * @dev Edits the timelock entry
	 * @param time The new timestamp until which this token will be locked
	 */
<span class="fstat-no" title="function not covered" >	function editTimeLock(uint256 time) public {</span>
<span class="cstat-no" title="statement not covered" >		require(</span>
			_securityToken.hasRole(bytes32("TIME_LOCK_EDITOR"), msg.sender),
			"!TIME_LOCK_EDITOR"
		);
<span class="cstat-no" title="statement not covered" >		_timeLock = time</span>;
<span class="cstat-no" title="statement not covered" >		emit TimeLockEdit(time);</span>
	}
&nbsp;
	/**
	 * @dev Validates live transfer. Can modify state
	 * @param msg_sender Sender of this function call
	 * @param partition Partition the tokens are being transferred from
	 * @param from Token holder.
	 * @return valid transfer is valid
	 * @return reason Why the transfer failed (intended for require statement)
	 */
<span class="fstat-no" title="function not covered" >	function executeTransfer(</span>
		address msg_sender,
		bytes32 partition,
		address, /* operator */
		address from,
		address, /* to */
		uint256, /* value */
		bytes calldata, /* data */
		bytes calldata /* operatorData */
	) external override returns (bool, string memory) {
<span class="cstat-no" title="statement not covered" >		if (_timeLock &gt; now) {</span>
<span class="cstat-no" title="statement not covered" >			return (false, "partition is still locked");</span>
		} else <span class="cstat-no" title="statement not covered" >if (_accountTimeLock[msg_sender] &gt; now) {</span>
<span class="cstat-no" title="statement not covered" >			return (false, "account is still locked");</span>
		} else <span class="cstat-no" title="statement not covered" >if (_amountTimeLock[msg_sender].time &gt; now) {</span>
			// this balance already has "value" substracted from it
<span class="cstat-no" title="statement not covered" >			uint256 userBalance = _securityToken.balanceOfByPartition(</span>
				partition,
				from
			);
&nbsp;
<span class="cstat-no" title="statement not covered" >			if (userBalance &lt; _amountTimeLock[msg_sender].amount) {</span>
<span class="cstat-no" title="statement not covered" >				return (false, "amount is still locked");</span>
			}
		}
&nbsp;
<span class="cstat-no" title="statement not covered" >		return (true, "");</span>
	}
&nbsp;
	/**
	 * @dev Returns module name
	 * @return bytes32 name of the constraint module
	 */
<span class="fstat-no" title="function not covered" >	function getModuleName() public override view returns (bytes32) {</span>
<span class="cstat-no" title="statement not covered" >		return _module_name;</span>
	}
&nbsp;
	/**
	 * @dev Returns token timelock
	 * @return uint256 unix timestamp until which the token is locked
	 */
<span class="fstat-no" title="function not covered" >	function getTimeLock() public view returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >		return _timeLock;</span>
	}
&nbsp;
	/**
	 * @dev Returns account timelock
	 * @return uint256 unix timestamp until which the accounnt is locked
	 */
<span class="fstat-no" title="function not covered" >	function getAccountTimeLock(address account) public view returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >		return _accountTimeLock[account];</span>
	}
&nbsp;
	/**
	 * @dev Returns amount timelock
	 * @return time uint256 unix timestamp until which the amount is locked
	 * @return amount uint256 amount that is locked
	 */
<span class="fstat-no" title="function not covered" >	function getAmountTimeLock(address account)</span>
		public
		view
		returns (uint256 time, uint256 amount)
	{
<span class="cstat-no" title="statement not covered" >		return (_amountTimeLock[account].time, _amountTimeLock[account].amount);</span>
	}
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue Dec 06 2022 11:29:26 GMT+0100 (Central European Standard Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
