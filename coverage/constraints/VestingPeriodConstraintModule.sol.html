<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for constraints/VestingPeriodConstraintModule.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">constraints/</a> VestingPeriodConstraintModule.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>0/20</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/6</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/9</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>0/20</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity 0.6.6;
&nbsp;
import "../../node_modules/@openzeppelin/contracts/math/SafeMath.sol";
&nbsp;
import "../interfaces/IConstraintModule.sol";
import "../interfaces/ISecurityToken.sol";
&nbsp;
&nbsp;
/**
 * @author Simon Dosch
 * @title VestingPeriodConstraintModule
 * @dev ConstraintModule
 * Define a vesting function including a locked period
 * Accounts can only transfer tokens when they are vested
 */
contract VestingPeriodConstraintModule is IConstraintModule {
	using SafeMath for uint256;
&nbsp;
	/**
	 * @dev Address of securityToken this ConstraintModule is used by
	 */
	ISecurityToken private _securityToken;
&nbsp;
	/**
	 * @dev Standard module name
	 */
	bytes32 private _module_name = bytes32("VESTING");
&nbsp;
	// EVENTS
	/**
	 * @dev Emitted when vesting options are set
	 */
	event VestingOptionsSet(
		uint256 vestingStart,
		uint256 vestedFractionAfterStart,
		uint256 vestingRatio
	);
&nbsp;
	// MODULE DATA
	/**
	 * @dev Time until vesting starts
	 */
	uint256 private _vestingStart;
&nbsp;
	/**
	 * @dev Fraction vested after starting
	 */
	uint256 private _vestedFraction;
&nbsp;
	/**
	 * @dev Fraction of tokens vested in 1 month
	 */
	uint256 private _vestingRatio;
&nbsp;
	/**
	 * @dev Tracks amount already spent by users
	 */
	mapping(address =&gt; uint256) private _amountSpentByUser;
&nbsp;
	/**
	 * [VestingPeriodConstraintModule CONSTRUCTOR]
	 * @dev Initialize VestingPeriodConstraintModule with security token address
	 * @param tokenAddress Address of securityToken this ConstraintModule is used by
	 */
<span class="fstat-no" title="function not covered" >	constructor(address tokenAddress) public {</span>
<span class="cstat-no" title="statement not covered" >		_securityToken = ISecurityToken(tokenAddress)</span>;
	}
&nbsp;
	// MODULE FUNCTIONS
	/**
	 * @dev Sets vesting options
	 * @param vestingStart Timestamp in seconds when vesting should start
	 * @param vestedFractionAfterStart i.e. 4  =&gt; 1/4
	 * @param vestingRatio i.e. 48 =&gt; 1/48
	 */
<span class="fstat-no" title="function not covered" >	function setVestingOptions(</span>
		uint256 vestingStart,
		uint256 vestedFractionAfterStart,
		uint256 vestingRatio
	) public {
<span class="cstat-no" title="statement not covered" >		require(</span>
			_securityToken.hasRole(
				bytes32("VESTING_PERIOD_EDITOR"),
				msg.sender
			),
			"!VESTING_PERIOD_EDITOR"
		);
&nbsp;
<span class="cstat-no" title="statement not covered" >		_vestingStart = vestingStart</span>;
<span class="cstat-no" title="statement not covered" >		_vestedFraction = vestedFractionAfterStart</span>;
<span class="cstat-no" title="statement not covered" >		_vestingRatio = vestingRatio</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >		emit VestingOptionsSet(</span>
			vestingStart,
			vestedFractionAfterStart,
			vestingRatio
		);
	}
&nbsp;
	/**
	 * @dev Validates live transfer. Can modify state
	 * @param partition Partition the tokens are being transferred from
	 * @param from Token holder.
	 * @param value Number of tokens to transfer.
	 * @return valid transfer is valid
	 * @return reason Why the transfer failed (intended for require statement)
	 */
<span class="fstat-no" title="function not covered" >	function executeTransfer(</span>
		address, /* msg_sender */
		bytes32 partition,
		address, /* operator */
		address from,
		address, /* to */
		uint256 value,
		bytes calldata, /* data */
		bytes calldata /* operatorData */
	) external override returns (bool, string memory) {
		// dormant Period not over
<span class="cstat-no" title="statement not covered" >		if (now &lt; _vestingStart) {</span>
<span class="cstat-no" title="statement not covered" >			return (false, "vesting has not started yet");</span>
		}
		// dormant period is over
&nbsp;
<span class="cstat-no" title="statement not covered" >		uint256 allowed = getAmountAllowed(partition, from, value);</span>
&nbsp;
		// amount exceeds allowance minus amountAlreadySpent by this acount
<span class="cstat-no" title="statement not covered" >		if (value &gt; (allowed.sub(_amountSpentByUser[from]))) {</span>
<span class="cstat-no" title="statement not covered" >			return (false, "amount exceeds vested amount");</span>
		}
&nbsp;
<span class="cstat-no" title="statement not covered" >		_amountSpentByUser[from] = _amountSpentByUser[from].add(value)</span>;
<span class="cstat-no" title="statement not covered" >		return (true, "");</span>
	}
&nbsp;
	/**
	 * @dev Returns allowed amount at this point in time for a specific account
	 * @param partition Partition the transfer originates from
	 * @param from Account tokens are being transferred from
	 * @param value Amount that is being transferred
	 * @return uint256 Allowed amount to be transferred at the moment
	 */
<span class="fstat-no" title="function not covered" >	function getAmountAllowed(</span>
		bytes32 partition,
		address from,
		uint256 value
	) internal view returns (uint256) {
		// calculate the original amount of tokens this account got
<span class="cstat-no" title="statement not covered" >		uint256 userOriginalBalance = _securityToken</span>
			.balanceOfByPartition(partition, from)
		// we need to add the value of this transfer as well
			.add(value)
			.add(_amountSpentByUser[from]);
&nbsp;
<span class="cstat-no" title="statement not covered" >		return</span>
			// the starting amount after the dormant period has passed
			// (i.e 1/4 where 4 is the fraction, hence originalBalance / fraction)
&nbsp;
			(userOriginalBalance.div(_vestedFraction))
&nbsp;
			// add to this
				.add(
				// the original balance multiplied by
				userOriginalBalance
					.mul(
					// the seconds that have passed since the dormant period was over
					// now - vestingStart
					(now.sub(_vestingStart))
					// divided by 1 month in seconds, gives us the number in months
						.div(2628288)
				)
				// so by multiplying with the monthsPassed and now dividing by the fraction the amount grows every month
				// (i.e. 48),
					.div(_vestingRatio)
			);
&nbsp;
		// we get the total amountAllowed at this point in time
	}
&nbsp;
	/**
	 * @dev Returns _vestingStart
	 * @return uint256 _vestingStart
	 */
<span class="fstat-no" title="function not covered" >	function getVestingStart() public view returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >		return _vestingStart;</span>
	}
&nbsp;
	/**
	 * @dev Returns _vestedFraction
	 * @return uint256 _vestedFraction
	 */
<span class="fstat-no" title="function not covered" >	function getVestedFractionAfterStart() public view returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >		return _vestedFraction;</span>
	}
&nbsp;
	/**
	 * @dev Returns _vestingRatio
	 * @return uint256 _vestingRatio
	 */
<span class="fstat-no" title="function not covered" >	function getVestingRatio() public view returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >		return _vestingRatio;</span>
	}
&nbsp;
	/**
	 * @dev Returns _amountSpentByUser
	 * @param user Account to get amountSpent for
	 * @return uint256 _amountSpentByUser
	 */
<span class="fstat-no" title="function not covered" >	function getAmountSpentByUser(address user) public view returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >		return _amountSpentByUser[user];</span>
	}
&nbsp;
	/**
	 * @dev Returns module name
	 * @return bytes32 name of the constraint module
	 */
<span class="fstat-no" title="function not covered" >	function getModuleName() public override view returns (bytes32) {</span>
<span class="cstat-no" title="statement not covered" >		return _module_name;</span>
	}
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue Oct 25 2022 12:09:15 GMT+0200 (Central European Summer Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
